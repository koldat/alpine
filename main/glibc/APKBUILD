# Maintainer: Tomas Kolda <tomas.kolda@broadcom.com>
pkgname=glibc
pkgver=2.35
pkgrel=3
pkgdesc="The GNU C Library"
url="https://www.gnu.org/software/libc/"
arch="all"
license="LGPL"
subpackages="
	$pkgname-dev
	$pkgname-ldtool
	$pkgname-libcrypt
	$pkgname-locales
	$pkgname-locale-en:localeen
	"
source="http://ftp.gnu.org/gnu/libc/glibc-$pkgver.tar.gz
glibc-2.35-fhs-1.patch
"

makedepends_build="linux-headers zlib-dev libpng-dev libcap-dev gettext procps util-linux gawk python3 make bison binutils gcc g++ libstdc++ glibc-dev grep"
depends="!musl"
options="lib64 !check"
triggers="glibc-ldtool.trigger=/lib:/usr/lib"

builddir="$srcdir/glibc-$pkgver"

build() {
	cd $builddir
	mkdir -v build
	cd build

	echo "rootsbindir=/usr/sbin" > configparms

	../configure                               \
		--build=$CBUILD                    \
		--host=$CHOST                      \
		--target=$CTARGET                  \
		--prefix=/usr                      \
		--with-headers=/usr/include        \
		--enable-kernel=3.2                \
		--enable-bind-now                  \
		--enable-stack-protector=strong    \
		--enable-tunables                  \
		--enable-cet                       \
		--disable-build-nscd               \
		--disable-nscd                     \
		--disable-werror                   \
		libc_cv_slibdir=/usr/lib

	make ASFLAGS="-g -Wa,--generate-missing-build-notes=yes"
}

ldtool() {
	depends="$pkgname"
	pkgdesc="Keeps ld.so.cache up to date"

	mkdir -p "$subpkgdir"
}

libcrypt() {
	depends="$pkgname"
	pkgdesc="Separate lib crypt"
	mkdir -p "$subpkgdir/usr/lib"
	mv $pkgdir/usr/lib/libcrypt* $subpkgdir/usr/lib
}

locales() {
	depends="$pkgname"
	pkgdesc="Generates locales"
	install="$subpkgname.post-install"
	mkdir -p "$subpkgdir"
}

localeen() {
	depends="$pkgname"
	pkgdesc="Generates en locales"
	install="$subpkgname.post-install"
	mkdir -p "$subpkgdir"
}

package() {
	cd $builddir/build

	make install DESTDIR="$pkgdir"

	cd $pkgdir
	mkdir lib
	ln -s lib lib64

	cd $pkgdir/usr
	ln -s lib lib64

	cd $pkgdir/lib
	ln -s ../usr/lib/ld-linux-x86-64.so.2 ld-linux-x86-64.so.2
	ln -s ../usr/lib/ld-linux-x86-64.so.2 ld-lsb-x86-64.so.3

	cd $pkgdir
	echo "/lib" >> etc/ld.so.conf
	echo "/usr/lib" >> etc/ld.so.conf
	usr/sbin/ldconfig -v -r ./
}


sha512sums="
45bf782aeda508e17fd51b45cf5ad96bd1067cf96b758b5c2d5def681af713df15e75c253d9c85de047f0a1dd22cf4f2239d70ae392cdb9291092e6570734d43  glibc-2.35.tar.gz
5b24f292cc87a133f45d743a95a8e706884e05ccf68024a0a88c0605c437928e111498feebca0259581da12d1ddb8e24726a67428e590240a1cbae48f7c2cc35  glibc-2.35-fhs-1.patch
"
